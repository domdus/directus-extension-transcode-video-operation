import e from"fs";import t from"path";import{exec as i}from"child_process";var o={id:"transcode-video-operation",handler:async({file:o,folder_id:r,playlist_reference_type:n="id",qualities:a=["240p","480p","720p","1080p","2160p"],threads:s=1},{env:d,services:c,getSchema:l,logger:p})=>{if(!o?.filename_disk)throw p?.info("[transcode-video-operation] Input file missing"),new Error("Input file missing");if(!r)throw p?.info("[transcode-video-operation] folder_id parameter is required"),new Error("folder_id parameter is required");const f=o.filename_disk.split(".")[0];o.filename_disk.substr(o.filename_disk.lastIndexOf(".")+1);const u=d.STORAGE_LOCATIONS?d.STORAGE_LOCATIONS.split(",").map((e=>e.trim())):[],h=u.length>0?u[0]:"local";let m;d[`STORAGE_${h.toUpperCase()}_ROOT`];const $=t=>e.readdirSync(t,"utf-8").filter((e=>e.startsWith(f))),g=async(i,o=null,r={})=>{try{const{FilesService:n}=c,a=new n({schema:await l()}),s=t.basename(i),d=s.substr(s.lastIndexOf(".")+1),p=e.statSync(i).size,f={ts:"video/mp2t",mp4:"video/mp4",jpeg:"image/jpeg",jpg:"image/jpeg",m3u8:"application/x-mpegurl"},u=(e.readFileSync(i),e.createReadStream(i)),m={storage:h,filename_disk:s,filename_download:s,title:s,type:r.mimetype||f[d]||"application/octet-stream",filesize:p};void 0!==r.width&&null!==r.width&&(m.width=r.width),void 0!==r.height&&null!==r.height&&(m.height=r.height),o&&(m.folder=o);const $=await a.createOne(m,{file:u,title:s}),g=$?.id||$?.data?.id||("string"==typeof $?$:null);if(!g)throw new Error(`Failed to get file ID from response. Response: ${JSON.stringify($)}`);return g}catch(e){throw p?.error(`[transcode-video-operation] (${f}) Error creating file record for ${i}:`,e),e}},v=(i,o,r=!1)=>{const n=e.readFileSync(i,"utf-8").split("\n"),a=[];for(const e of n)if(e.startsWith("#")||""===e.trim())a.push(e);else{let i=e.trim();i.startsWith("/assets/")&&(i=i.substring(8));const n=t.basename(i),s=o[i]||o[n];s?r?a.push(i):a.push(s):(p?.warn(`[transcode-video-operation] (${i}) File ID not found for: ${i} (tried: ${i}, ${n})`),a.push(e))}return a.join("\n")};function _(e,t){return new Promise(((o,r)=>{i(`ffmpeg -y -i ${e} -threads ${w} ${t.options}`,((e,i,n)=>e?(p?.error(`[transcode-video-operation] (${f}) Error occured for quality: %s`,t.id),p?.error(e.message),p?.error(`stdout: ${i}`),p?.error(`stderr: ${n}`),void r(new Error(`FFmpeg transcoding failed for quality ${t.id}p: ${e.message}. stderr: ${n}`))):n&&(n.includes("not found")||n.includes("command not found"))?(p?.error(`[transcode-video-operation] (${f}) FFmpeg not found in stderr for quality: %s`,t.id),p?.error(`stderr: ${n}`),void r(new Error(`FFmpeg command not found. stderr: ${n}`))):(p?.info(`[transcode-video-operation] (${f}) Transcoding finished for quality: %s`,t.id),void o(i.trim()))))}))}p?.info(`[transcode-video-operation] (${f}) Operation started`);const y=null!=s?parseInt(s,10):1,w=isNaN(y)||y<0?1:y,b=(e=>{const t=`STORAGE_${e.toUpperCase()}_ROOT`,i=d[t];return i||(p?.warn(`[transcode-video-operation] (${f}) No storage found for location <%s>`,e),null)})(o.storage);if(!b)return{error:`No storage found for location <${o.storage}>`};const S=process.env.PWD||"/directus",k=t.join(S,`${b}/${o.filename_disk}`);if(!e.existsSync(k))return p?.error(`[transcode-video-operation] (${f}) Source file not found: %s`,k),{error:`Source file not found: ${k}`};m=t.dirname(k),p?.info(`[transcode-video-operation] (${f}) File to be transcoded: %s`,k),p?.info(`[transcode-video-operation] (${f}) Output directory: %s`,m),e.existsSync(m)||(e.mkdirSync(m,{recursive:!0}),p?.info(`[transcode-video-operation] (${f}) Folder created`));try{await new Promise(((e,t)=>{i("which ffmpeg",((i,o,r)=>{!i&&o.trim()?e():t(new Error("FFmpeg is not installed or not found in PATH. Please install ffmpeg."))}))})),p?.info(`[transcode-video-operation] (${f}) FFmpeg is available`)}catch(e){throw p?.error(`[transcode-video-operation] (${f}) FFmpeg check failed: %s`,e.message),e}const E=await new Promise(((e,t)=>{i(`ffprobe -v error -select_streams v:0 -show_entries stream=pix_fmt -of json ${k}`,((t,i)=>{if(t)return p?.warn(`[transcode-video-operation] (${f}) Error checking bit depth, assuming 8-bit: %s`,t.message),void e(!1);try{const t=JSON.parse(i),o=t.streams?.[0]?.pix_fmt;e(o?.includes("10")||!1)}catch(t){p?.warn(`[transcode-video-operation] (${f}) Error parsing bit depth check, assuming 8-bit`),e(!1)}}))}));E&&p?.info(`[transcode-video-operation] (${f}) High bit depth detected, will convert to yuv420p`),p?.info(`[transcode-video-operation] (${f}) Getting source video metadata...`);const F=await(async e=>new Promise(((t,o)=>{i(`ffprobe -v error -select_streams v:0 -show_entries stream=width,height:format=duration -of json ${e}`,((e,i)=>{if(e)return p?.error(`[transcode-video-operation] (${f}) Error getting video metadata:`,e),void o(e);try{const e=JSON.parse(i),r=e.streams?.[0],n=e.format;if(!r||!r.width||!r.height)return void o(new Error("Could not get video dimensions"));const a=parseInt(r.width),s=parseInt(r.height),d=n?.duration?Math.floor(1e3*parseFloat(n.duration)):0;t({width:a,height:s,isVertical:s>a,duration:d})}catch(e){p?.error(`[transcode-video-operation] (${f}) Error parsing metadata:`,e),o(e)}}))})))(k).catch((e=>(p?.error(`[transcode-video-operation] (${f}) Error getting source metadata:`,e),{width:99999,height:99999,isVertical:!1,duration:0}))),O=F.height;p?.info(`[transcode-video-operation] (${f}) Source video resolution: ${F.width}x${O}`);const T=((e=!1)=>{const t="main",i=e?"format=yuv420p,":"";return[{id:240,options:`-vf "${i}scale=w='min(426,iw)':h='min(240,ih)':force_original_aspect_ratio=decrease,scale=trunc(iw/2)*2:trunc(ih/2)*2" -c:a aac -ar 48000 -c:v h264 -profile:v ${t} -crf 22 -sc_threshold 0 -g 48 -keyint_min 48 -hls_time 4 -hls_playlist_type vod -b:v 400k -maxrate 428k -bufsize 600k -b:a 64k -hls_segment_filename ${m}/${f}_240p_%03d.ts ${m}/${f}_240p.m3u8`},{id:480,options:`-vf "${i}scale=w='min(854,iw)':h='min(480,ih)':force_original_aspect_ratio=decrease,scale=trunc(iw/2)*2:trunc(ih/2)*2" -c:a aac -ar 48000 -c:v h264 -profile:v ${t} -crf 20 -sc_threshold 0 -g 48 -keyint_min 48 -hls_time 4 -hls_playlist_type vod -b:v 1400k -maxrate 1498k -bufsize 2100k -b:a 128k -hls_segment_filename ${m}/${f}_480p_%03d.ts ${m}/${f}_480p.m3u8`},{id:720,options:`-vf "${i}scale=w='min(1280,iw)':h='min(720,ih)':force_original_aspect_ratio=decrease,scale=trunc(iw/2)*2:trunc(ih/2)*2" -c:a aac -ar 48000 -c:v h264 -profile:v ${t} -crf 20 -sc_threshold 0 -g 48 -keyint_min 48 -hls_time 4 -hls_playlist_type vod -b:v 2800k -maxrate 2996k -bufsize 4200k -b:a 128k -hls_segment_filename ${m}/${f}_720p_%03d.ts ${m}/${f}_720p.m3u8`},{id:1080,options:`-vf "${i}scale=w='min(1920,iw)':h='min(1080,ih)':force_original_aspect_ratio=decrease,scale=trunc(iw/2)*2:trunc(ih/2)*2" -c:a aac -ar 48000 -c:v h264 -profile:v ${t} -crf 20 -sc_threshold 0 -g 48 -keyint_min 48 -hls_time 4 -hls_playlist_type vod -b:v 5000k -maxrate 5350k -bufsize 7500k -b:a 192k -hls_segment_filename ${m}/${f}_1080p_%03d.ts ${m}/${f}_1080p.m3u8`},{id:2160,options:`-vf "${i}scale=w='min(3840,iw)':h='min(2160,ih)':force_original_aspect_ratio=decrease,scale=trunc(iw/2)*2:trunc(ih/2)*2" -c:a aac -ar 48000 -c:v h264 -profile:v ${t} -crf 20 -sc_threshold 0 -g 48 -keyint_min 48 -hls_time 4 -hls_playlist_type vod -b:v 20000k -maxrate 21400k -bufsize 30000k -b:a 192k -hls_segment_filename ${m}/${f}_2160p_%03d.ts ${m}/${f}_2160p.m3u8`}]})(E);let I=["240p","480p","720p","1080p","2160p"];if(a)if(Array.isArray(a))I=a;else if("string"==typeof a)try{I=JSON.parse(a)}catch(e){p?.warn(`[transcode-video-operation] (${f}) Could not parse qualities, using all:`,e)}I=I.map((e=>{if("string"==typeof e){const t=e.replace(/p$/i,"");return parseInt(t,10)}return e})).filter((e=>!isNaN(e)));const N={240:240,480:480,720:720,1080:1080,2160:2160};let x=T.filter((e=>I.includes(e.id)));const A=x.length;if(x=x.filter((e=>{const t=N[e.id];return!(t&&t>O)||(p?.info(`[transcode-video-operation] (${f}) Skipping ${e.id}p (target: ${t}px, source: ${O}px) to prevent upscaling`),!1)})),A>x.length&&p?.info(`[transcode-video-operation] (${f}) Filtered out ${A-x.length} quality level(s) that would require upscaling`),p?.info(`[transcode-video-operation] (${f}) Selected qualities: ${I.join(", ")}`),p?.info(`[transcode-video-operation] (${f}) Will transcode ${x.length} quality levels`),0===x.length)return{error:"No quality levels selected for transcoding"};const R=$(m).some((e=>e.includes("_240p")||e.includes("_480p")||e.includes("_720p")||e.includes("_1080p")||e.includes("_2160p")));if(R)p?.info(`[transcode-video-operation] (${f}) Transcoded files already exist, skipping transcoding`);else{p?.info(`[transcode-video-operation] (${f}) No existing files found, starting transcoding...`);for(const e of x)try{p?.info(`[transcode-video-operation] (${f}) Starting transcoding for quality: %sp`,e.id),await _(k,e),p?.info(`[transcode-video-operation] (${f}) Successfully transcoded quality: %sp`,e.id)}catch(t){throw p?.error(`[transcode-video-operation] (${f}) Failed to transcode quality %sp:`,e.id,t),t}p?.info(`[transcode-video-operation] (${f}) All qualities transcoded successfully`)}const q=["#EXTM3U","#EXT-X-VERSION:3"];for(const t of x){const i=`${m}/${f}_${t.id}p.m3u8`;if(e.existsSync(i))switch(t.id){case 240:q.push("#EXT-X-STREAM-INF:BANDWIDTH=400000,RESOLUTION=426x240",`${f}_240p.m3u8`);break;case 480:q.push("#EXT-X-STREAM-INF:BANDWIDTH=1400000,RESOLUTION=854x480",`${f}_480p.m3u8`);break;case 720:q.push("#EXT-X-STREAM-INF:BANDWIDTH=2800000,RESOLUTION=1280x720",`${f}_720p.m3u8`);break;case 1080:q.push("#EXT-X-STREAM-INF:BANDWIDTH=5000000,RESOLUTION=1920x1080",`${f}_1080p.m3u8`);break;case 2160:q.push("#EXT-X-STREAM-INF:BANDWIDTH=20000000,RESOLUTION=3840x2160",`${f}_2160p.m3u8`)}}e.writeFileSync(`${m}/${f}_playlist.m3u8`,q.join("\n")),p?.info(`[transcode-video-operation] (${f}) Master playlist created: ${f}_playlist.m3u8`);const D=F,j=`${m}/${f}_thumb.jpg`;let C=null;try{await(async(e,t)=>new Promise(((o,r)=>{i(`ffmpeg -y -i ${e} -ss 1 -vframes 1 -q:v 2 ${t}`,(e=>{e?(p?.error(`[transcode-video-operation] (${f}) Error extracting thumbnail:`,e),r(e)):o(t)}))})))(k,j),p?.info(`[transcode-video-operation] (${f}) Thumbnail extracted`)}catch(e){p?.error(`[transcode-video-operation] (${f}) Error extracting thumbnail:`,e)}p?.info(`[transcode-video-operation] (${f}) Creating virtual folder...`);const W=await(async(e,t=null)=>{try{const{FoldersService:i}=c,o=new i({schema:await l()}),r={name:{_eq:e}};t&&(r.parent={_eq:t});const n=await o.readByQuery({filter:r});if(n&&n.length>0){const e=n[0]?.id||n[0]?.data?.id||n[0];return p?.info(`[transcode-video-operation] (${f}) Found existing folder: ${e}`),e}const a={name:e};t?(a.parent=t,p?.info(`[transcode-video-operation] (${f}) Creating folder "${e}" with parent ${t}`)):p?.info(`[transcode-video-operation] (${f}) Creating folder "${e}" at root`);const s=await o.createOne(a);p?.debug(`[transcode-video-operation] (${f}) Folder creation response:`,JSON.stringify(s,null,2));const d=s?.id||s?.data?.id||("string"==typeof s?s:null);if(!d)throw new Error(`Failed to get folder ID from response: ${JSON.stringify(s)}`);return p?.info(`[transcode-video-operation] (${f}) Created folder with ID: ${d}`),d}catch(e){throw p?.error(`[transcode-video-operation] (${f}) Error creating folder:`,e),e}})(f,r);p?.info(`[transcode-video-operation] (${f}) Created/using folder: ${W}`);const X=$(m);p?.info(`[transcode-video-operation] (${f}) Found ${X.length} files to upload`);const M={},P=[];if(e.existsSync(j))try{let e=null,o=null;try{const t=await(async e=>new Promise(((t,o)=>{i(`ffprobe -v error -select_streams v:0 -show_entries stream=width,height -of json ${e}`,((e,i)=>{if(e)return p?.error(`[transcode-video-operation] (${f}) Error getting image metadata:`,e),void o(e);try{const e=JSON.parse(i),r=e.streams?.[0];if(!r||!r.width||!r.height)return void o(new Error("Could not get image dimensions"));const n=parseInt(r.width),a=parseInt(r.height);t({width:n,height:a})}catch(e){p?.error(`[transcode-video-operation] (${f}) Error parsing image metadata:`,e),o(e)}}))})))(j);e=t.width,o=t.height,p?.info(`[transcode-video-operation] (${f}) Thumbnail dimensions: ${e}x${o}`)}catch(e){p?.warn(`[transcode-video-operation] (${f}) Could not get thumbnail dimensions:`,e)}C=await g(j,W,{mimetype:"image/jpeg",width:e,height:o}),M[t.basename(j)]=C,P.push({filename_disk:t.basename(j),id:C}),p?.info(`[transcode-video-operation] (${f}) Thumbnail uploaded: ${C}`)}catch(e){p?.error(`[transcode-video-operation] (${f}) Error uploading thumbnail:`,e)}for(const e of X){if(e===o.filename_disk||e.endsWith("_thumb.jpg")||e===`${f}_playlist.m3u8`)continue;const t=`${m}/${e}`;try{const i=await g(t,W);M[e]=i,P.push({filename_disk:e,id:i})}catch(t){p?.error(`[transcode-video-operation] (${f}) Error uploading ${e}:`,t)}}p?.info(`[transcode-video-operation] (${f}) All files uploaded to Directus: ${P.length} files total`);const U="filename_disk"===n,z=U?"filename_disk":"file IDs";p?.info(`[transcode-video-operation] (${f}) Rebuilding playlists with ${z}...`);for(const i of x){const o=`${m}/${f}_${i.id}p.m3u8`;if(e.existsSync(o)){const r=v(o,M,U);e.writeFileSync(o,r);try{const e=await g(o,W);M[t.basename(o)]=e,P.push({filename_disk:t.basename(o),id:e}),p?.info(`[transcode-video-operation] (${f}) Rebuilt and uploaded ${i.id}p playlist: ${e}`)}catch(e){p?.error(`[transcode-video-operation] (${f}) Error re-uploading ${i.id}p playlist:`,e)}}}const H=`${m}/${f}_playlist.m3u8`,J=e.readFileSync(H,"utf-8").split("\n"),L=[];for(const e of J)if(e.startsWith("#")||""===e.trim())L.push(e);else{let i=e.trim();i.startsWith("/assets/")&&(i=i.substring(8));const o=t.basename(i),r=M[i]||M[o];r?U?L.push(i):L.push(r):(p?.warn(`[transcode-video-operation] (${f}) File ID not found for playlist: ${i} (tried: ${i}, ${o})`),L.push(e))}e.writeFileSync(H,L.join("\n"));let B=null;try{B=await g(H,W),p?.info(`[transcode-video-operation] (${f}) Master playlist uploaded: ${B}`)}catch(e){p?.error(`[transcode-video-operation] (${f}) Error uploading master playlist:`,e)}const G=[];for(const t of x){const i=`${m}/${f}_${t.id}p.m3u8`;e.existsSync(i)&&G.push(t.id)}return{master:{id:B,filename_disk:`${f}_playlist.m3u8`},metadata:{availableQualities:G,dimensions:{width:D.width,height:D.height,isVertical:D.isVertical},duration:D.duration,thumbnail:C},files:P}}};export{o as default};
