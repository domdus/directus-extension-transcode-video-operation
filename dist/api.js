import e from"fs";import i from"path";import{exec as t}from"child_process";var r={id:"transcode-video-operation",handler:async({file:r,folder_id:o,playlist_reference_type:n="id",qualities:a=["240p","480p","720p","1080p","2160p"],threads:s=1},{env:d,services:c,getSchema:l,logger:p})=>{if(!r?.filename_disk)throw p?.info("[transcode-video-operation] Input file missing"),new Error("Input file missing");if(!o)throw p?.info("[transcode-video-operation] folder_id parameter is required"),new Error("folder_id parameter is required");const f=r.filename_disk.split(".")[0];r.filename_disk.substr(r.filename_disk.lastIndexOf(".")+1);const u=d.STORAGE_LOCATIONS?d.STORAGE_LOCATIONS.split(",").map((e=>e.trim())):[],h=u.length>0?u[0]:"local";let m;d[`STORAGE_${h.toUpperCase()}_ROOT`];const $=i=>e.readdirSync(i,"utf-8").filter((e=>e.startsWith(f))),g=async(t,r=null,o={})=>{try{const{FilesService:n}=c,a=new n({schema:await l()}),s=i.basename(t),d=s.substr(s.lastIndexOf(".")+1),p=e.statSync(t).size,f={ts:"video/mp2t",mp4:"video/mp4",jpeg:"image/jpeg",jpg:"image/jpeg",m3u8:"application/x-mpegurl"},u=(e.readFileSync(t),e.createReadStream(t)),m={storage:h,filename_disk:s,filename_download:s,title:s,type:o.mimetype||f[d]||"application/octet-stream",filesize:p};void 0!==o.width&&null!==o.width&&(m.width=o.width),void 0!==o.height&&null!==o.height&&(m.height=o.height),r&&(m.folder=r);const $=await a.createOne(m,{file:u,title:s}),g=$?.id||$?.data?.id||("string"==typeof $?$:null);if(!g)throw new Error(`Failed to get file ID from response. Response: ${JSON.stringify($)}`);return String(g)}catch(e){throw p?.error(`[transcode-video-operation] (${f}) Error creating file record for ${t}:`,e),e}},v=(t,r,o=!1)=>{const n=e.readFileSync(t,"utf-8").split("\n"),a=[];for(const e of n)if(e.startsWith("#")||""===e.trim())a.push(e);else{let t=e.trim();t.startsWith("/assets/")&&(t=t.substring(8));const n=i.basename(t),s=r[t]||r[n];s?o?a.push(t):a.push(s):(p?.warn(`[transcode-video-operation] (${t}) File ID not found for: ${t} (tried: ${t}, ${n})`),a.push(e))}return a.join("\n")};function _(e,i,r){return new Promise(((o,n)=>{t(`ffmpeg -y -i ${e} -threads ${r} ${i.options}`,((e,t,r)=>e?(p?.error(`[transcode-video-operation] (${f}) Error occured for quality: %s`,i.id),p?.error(e.message),p?.error(`stdout: ${t}`),p?.error(`stderr: ${r}`),void n(new Error(`FFmpeg transcoding failed for quality ${i.id}p: ${e.message}. stderr: ${r}`))):r&&(r.includes("not found")||r.includes("command not found"))?(p?.error(`[transcode-video-operation] (${f}) FFmpeg not found in stderr for quality: %s`,i.id),p?.error(`stderr: ${r}`),void n(new Error(`FFmpeg command not found. stderr: ${r}`))):(p?.info(`[transcode-video-operation] (${f}) Transcoding finished for quality: %s`,i.id),void o(t.trim()))))}))}p?.info(`[transcode-video-operation] (${f}) Operation started`);const y=null!=s?parseInt(String(s),10):1,w=isNaN(y)||y<0?1:y,S=(e=>{const i=`STORAGE_${e.toUpperCase()}_ROOT`,t=d[i];return t?String(t):(p?.warn(`[transcode-video-operation] (${f}) No storage found for location <%s>`,e),null)})(r.storage);if(!S)return{error:`No storage found for location <${r.storage}>`};const b=process.env.PWD||"/directus",k=i.join(b,`${S}/${r.filename_disk}`);if(!e.existsSync(k))return p?.error(`[transcode-video-operation] (${f}) Source file not found: %s`,k),{error:`Source file not found: ${k}`};m=i.dirname(k),p?.info(`[transcode-video-operation] (${f}) File to be transcoded: %s`,k),p?.info(`[transcode-video-operation] (${f}) Output directory: %s`,m),e.existsSync(m)||(e.mkdirSync(m,{recursive:!0}),p?.info(`[transcode-video-operation] (${f}) Folder created`));try{await new Promise(((e,i)=>{t("which ffmpeg",((t,r,o)=>{!t&&r.trim()?e():i(new Error("FFmpeg is not installed or not found in PATH. Please install ffmpeg."))}))})),p?.info(`[transcode-video-operation] (${f}) FFmpeg is available`)}catch(e){throw p?.error(`[transcode-video-operation] (${f}) FFmpeg check failed: %s`,e instanceof Error?e.message:String(e)),e}const E=await new Promise(((e,i)=>{t(`ffprobe -v error -select_streams v:0 -show_entries stream=pix_fmt -of json ${k}`,((i,t)=>{if(i)return p?.warn(`[transcode-video-operation] (${f}) Error checking bit depth, assuming 8-bit: %s`,i.message),void e(!1);try{const i=JSON.parse(t),r=i.streams?.[0]?.pix_fmt;e(r?.includes("10")||!1)}catch(i){p?.warn(`[transcode-video-operation] (${f}) Error parsing bit depth check, assuming 8-bit`),e(!1)}}))}));E&&p?.info(`[transcode-video-operation] (${f}) High bit depth detected, will convert to yuv420p`),p?.info(`[transcode-video-operation] (${f}) Getting source video metadata...`);const F=await(async e=>new Promise(((i,r)=>{t(`ffprobe -v error -select_streams v:0 -show_entries stream=width,height:format=duration -of json ${e}`,((e,t)=>{if(e)return p?.error(`[transcode-video-operation] (${f}) Error getting video metadata:`,e),void r(e);try{const e=JSON.parse(t),o=e.streams?.[0],n=e.format;if(!o||!o.width||!o.height)return void r(new Error("Could not get video dimensions"));const a=parseInt(o.width),s=parseInt(o.height),d=n?.duration?Math.floor(1e3*parseFloat(n.duration)):0;i({width:a,height:s,isVertical:s>a,duration:d})}catch(e){p?.error(`[transcode-video-operation] (${f}) Error parsing metadata:`,e),r(e)}}))})))(k).catch((e=>(p?.error(`[transcode-video-operation] (${f}) Error getting source metadata:`,e),{width:99999,height:99999,isVertical:!1,duration:0}))),O=F.height;p?.info(`[transcode-video-operation] (${f}) Source video resolution: ${F.width}x${O}`);const T=((e=!1)=>{const i="main",t=e?"format=yuv420p,":"";return[{id:240,options:`-vf "${t}scale=w='min(426,iw)':h='min(240,ih)':force_original_aspect_ratio=decrease,scale=trunc(iw/2)*2:trunc(ih/2)*2" -c:a aac -ar 48000 -c:v h264 -profile:v ${i} -crf 22 -sc_threshold 0 -g 48 -keyint_min 48 -hls_time 4 -hls_playlist_type vod -b:v 400k -maxrate 428k -bufsize 600k -b:a 64k -hls_segment_filename ${m}/${f}_240p_%03d.ts ${m}/${f}_240p.m3u8`},{id:480,options:`-vf "${t}scale=w='min(854,iw)':h='min(480,ih)':force_original_aspect_ratio=decrease,scale=trunc(iw/2)*2:trunc(ih/2)*2" -c:a aac -ar 48000 -c:v h264 -profile:v ${i} -crf 20 -sc_threshold 0 -g 48 -keyint_min 48 -hls_time 4 -hls_playlist_type vod -b:v 1400k -maxrate 1498k -bufsize 2100k -b:a 128k -hls_segment_filename ${m}/${f}_480p_%03d.ts ${m}/${f}_480p.m3u8`},{id:720,options:`-vf "${t}scale=w='min(1280,iw)':h='min(720,ih)':force_original_aspect_ratio=decrease,scale=trunc(iw/2)*2:trunc(ih/2)*2" -c:a aac -ar 48000 -c:v h264 -profile:v ${i} -crf 20 -sc_threshold 0 -g 48 -keyint_min 48 -hls_time 4 -hls_playlist_type vod -b:v 2800k -maxrate 2996k -bufsize 4200k -b:a 128k -hls_segment_filename ${m}/${f}_720p_%03d.ts ${m}/${f}_720p.m3u8`},{id:1080,options:`-vf "${t}scale=w='min(1920,iw)':h='min(1080,ih)':force_original_aspect_ratio=decrease,scale=trunc(iw/2)*2:trunc(ih/2)*2" -c:a aac -ar 48000 -c:v h264 -profile:v ${i} -crf 20 -sc_threshold 0 -g 48 -keyint_min 48 -hls_time 4 -hls_playlist_type vod -b:v 5000k -maxrate 5350k -bufsize 7500k -b:a 192k -hls_segment_filename ${m}/${f}_1080p_%03d.ts ${m}/${f}_1080p.m3u8`},{id:2160,options:`-vf "${t}scale=w='min(3840,iw)':h='min(2160,ih)':force_original_aspect_ratio=decrease,scale=trunc(iw/2)*2:trunc(ih/2)*2" -c:a aac -ar 48000 -c:v h264 -profile:v ${i} -crf 20 -sc_threshold 0 -g 48 -keyint_min 48 -hls_time 4 -hls_playlist_type vod -b:v 20000k -maxrate 21400k -bufsize 30000k -b:a 192k -hls_segment_filename ${m}/${f}_2160p_%03d.ts ${m}/${f}_2160p.m3u8`}]})(E);let I=["240p","480p","720p","1080p","2160p"];if(a)if(Array.isArray(a))I=a;else if("string"==typeof a)try{I=JSON.parse(a)}catch(e){p?.warn(`[transcode-video-operation] (${f}) Could not parse qualities, using all:`,e)}const N=I.map((e=>{if("string"==typeof e){const i=e.replace(/p$/i,"");return parseInt(i,10)}return e})).filter((e=>!isNaN(e))),x={240:240,480:480,720:720,1080:1080,2160:2160};let A=T.filter((e=>N.includes(e.id)));const R=A.length;if(A=A.filter((e=>{const i=x[e.id];return!(i&&i>O)||(p?.info(`[transcode-video-operation] (${f}) Skipping ${e.id}p (target: ${i}px, source: ${O}px) to prevent upscaling`),!1)})),R>A.length&&p?.info(`[transcode-video-operation] (${f}) Filtered out ${R-A.length} quality level(s) that would require upscaling`),p?.info(`[transcode-video-operation] (${f}) Selected qualities: ${N.join(", ")}`),p?.info(`[transcode-video-operation] (${f}) Will transcode ${A.length} quality levels`),0===A.length)return{error:"No quality levels selected for transcoding"};if($(m).some((e=>e.includes("_240p")||e.includes("_480p")||e.includes("_720p")||e.includes("_1080p")||e.includes("_2160p"))))p?.info(`[transcode-video-operation] (${f}) Transcoded files already exist, skipping transcoding`);else{p?.info(`[transcode-video-operation] (${f}) No existing files found, starting transcoding...`);for(const e of A)try{p?.info(`[transcode-video-operation] (${f}) Starting transcoding for quality: %sp`,e.id),await _(k,e,w),p?.info(`[transcode-video-operation] (${f}) Successfully transcoded quality: %sp`,e.id)}catch(i){throw p?.error(`[transcode-video-operation] (${f}) Failed to transcode quality %sp:`,e.id,i),i}p?.info(`[transcode-video-operation] (${f}) All qualities transcoded successfully`)}const q=["#EXTM3U","#EXT-X-VERSION:3"];for(const i of A){const t=`${m}/${f}_${i.id}p.m3u8`;if(e.existsSync(t))switch(i.id){case 240:q.push("#EXT-X-STREAM-INF:BANDWIDTH=400000,RESOLUTION=426x240",`${f}_240p.m3u8`);break;case 480:q.push("#EXT-X-STREAM-INF:BANDWIDTH=1400000,RESOLUTION=854x480",`${f}_480p.m3u8`);break;case 720:q.push("#EXT-X-STREAM-INF:BANDWIDTH=2800000,RESOLUTION=1280x720",`${f}_720p.m3u8`);break;case 1080:q.push("#EXT-X-STREAM-INF:BANDWIDTH=5000000,RESOLUTION=1920x1080",`${f}_1080p.m3u8`);break;case 2160:q.push("#EXT-X-STREAM-INF:BANDWIDTH=20000000,RESOLUTION=3840x2160",`${f}_2160p.m3u8`)}}e.writeFileSync(`${m}/${f}_playlist.m3u8`,q.join("\n")),p?.info(`[transcode-video-operation] (${f}) Master playlist created: ${f}_playlist.m3u8`);const D=F,j=`${m}/${f}_thumb.jpg`;let C=null;try{await(async(e,i)=>new Promise(((r,o)=>{t(`ffmpeg -y -i ${e} -ss 1 -vframes 1 -q:v 2 ${i}`,(e=>{e?(p?.error(`[transcode-video-operation] (${f}) Error extracting thumbnail:`,e),o(e)):r(i)}))})))(k,j),p?.info(`[transcode-video-operation] (${f}) Thumbnail extracted`)}catch(e){p?.error(`[transcode-video-operation] (${f}) Error extracting thumbnail:`,e)}p?.info(`[transcode-video-operation] (${f}) Creating virtual folder...`);const W=await(async(e,i=null)=>{try{const{FoldersService:t}=c,r=new t({schema:await l()}),o={name:{_eq:e}};i&&(o.parent={_eq:i});const n=await r.readByQuery({filter:o});if(n&&Array.isArray(n)&&n.length>0){const e=n[0]?.id||n[0]?.data?.id||n[0];return p?.info(`[transcode-video-operation] (${f}) Found existing folder: ${e}`),String(e)}const a={name:e};i?(a.parent=i,p?.info(`[transcode-video-operation] (${f}) Creating folder "${e}" with parent ${i}`)):p?.info(`[transcode-video-operation] (${f}) Creating folder "${e}" at root`);const s=await r.createOne(a);p?.debug(`[transcode-video-operation] (${f}) Folder creation response:`,JSON.stringify(s,null,2));const d=s?.id||s?.data?.id||("string"==typeof s?s:null);if(!d)throw new Error(`Failed to get folder ID from response: ${JSON.stringify(s)}`);return p?.info(`[transcode-video-operation] (${f}) Created folder with ID: ${d}`),String(d)}catch(e){throw p?.error(`[transcode-video-operation] (${f}) Error creating folder:`,e),e}})(f,o);p?.info(`[transcode-video-operation] (${f}) Created/using folder: ${W}`);const X=$(m);p?.info(`[transcode-video-operation] (${f}) Found ${X.length} files to upload`);const M={},P=[];if(e.existsSync(j))try{let e=null,r=null;try{const i=await(async e=>new Promise(((i,r)=>{t(`ffprobe -v error -select_streams v:0 -show_entries stream=width,height -of json ${e}`,((e,t)=>{if(e)return p?.error(`[transcode-video-operation] (${f}) Error getting image metadata:`,e),void r(e);try{const e=JSON.parse(t),o=e.streams?.[0];if(!o||!o.width||!o.height)return void r(new Error("Could not get image dimensions"));const n=parseInt(o.width),a=parseInt(o.height);i({width:n,height:a})}catch(e){p?.error(`[transcode-video-operation] (${f}) Error parsing image metadata:`,e),r(e)}}))})))(j);e=i.width,r=i.height,p?.info(`[transcode-video-operation] (${f}) Thumbnail dimensions: ${e}x${r}`)}catch(e){p?.warn(`[transcode-video-operation] (${f}) Could not get thumbnail dimensions:`,e)}C=await g(j,W,{mimetype:"image/jpeg",width:e,height:r}),M[i.basename(j)]=C,P.push({filename_disk:i.basename(j),id:C}),p?.info(`[transcode-video-operation] (${f}) Thumbnail uploaded: ${C}`)}catch(e){p?.error(`[transcode-video-operation] (${f}) Error uploading thumbnail:`,e)}for(const e of X){if(e===r.filename_disk||e.endsWith("_thumb.jpg")||e===`${f}_playlist.m3u8`)continue;const i=`${m}/${e}`;try{const t=await g(i,W);M[e]=t,P.push({filename_disk:e,id:t})}catch(i){p?.error(`[transcode-video-operation] (${f}) Error uploading ${e}:`,i)}}p?.info(`[transcode-video-operation] (${f}) All files uploaded to Directus: ${P.length} files total`);const U="filename_disk"===n,z=U?"filename_disk":"file IDs";p?.info(`[transcode-video-operation] (${f}) Rebuilding playlists with ${z}...`);for(const t of A){const r=`${m}/${f}_${t.id}p.m3u8`;if(e.existsSync(r)){const o=v(r,M,U);e.writeFileSync(r,o);try{const e=await g(r,W);M[i.basename(r)]=e,P.push({filename_disk:i.basename(r),id:e}),p?.info(`[transcode-video-operation] (${f}) Rebuilt and uploaded ${t.id}p playlist: ${e}`)}catch(e){p?.error(`[transcode-video-operation] (${f}) Error re-uploading ${t.id}p playlist:`,e)}}}const H=`${m}/${f}_playlist.m3u8`,J=e.readFileSync(H,"utf-8").split("\n"),L=[];for(const e of J)if(e.startsWith("#")||""===e.trim())L.push(e);else{let t=e.trim();t.startsWith("/assets/")&&(t=t.substring(8));const r=i.basename(t),o=M[t]||M[r];o?U?L.push(t):L.push(o):(p?.warn(`[transcode-video-operation] (${f}) File ID not found for playlist: ${t} (tried: ${t}, ${r})`),L.push(e))}e.writeFileSync(H,L.join("\n"));let B=null;try{B=await g(H,W),p?.info(`[transcode-video-operation] (${f}) Master playlist uploaded: ${B}`)}catch(e){p?.error(`[transcode-video-operation] (${f}) Error uploading master playlist:`,e)}const G=[];for(const i of A){const t=`${m}/${f}_${i.id}p.m3u8`;e.existsSync(t)&&G.push(i.id)}return{master:{id:B,filename_disk:`${f}_playlist.m3u8`},metadata:{availableQualities:G,dimensions:{width:D.width,height:D.height,isVertical:D.isVertical},duration:D.duration,thumbnail:C},files:P}}};export{r as default};
